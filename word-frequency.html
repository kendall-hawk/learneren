<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯é¢‘ç»Ÿè®¡åˆ†æ</title>
    <meta name="description" content="å…¨ç«™è‹±æ–‡è¯æ±‡é¢‘æ¬¡ç»Ÿè®¡åˆ†æï¼Œæ”¯æŒæ™ºèƒ½æœç´¢å’Œç²¾ç¡®æœç´¢">
    <meta name="keywords" content="è¯é¢‘ç»Ÿè®¡,è‹±è¯­å­¦ä¹ ,è¯æ±‡åˆ†æ,å•è¯é¢‘æ¬¡">
    
    <!-- åŸºç¡€æ ·å¼ -->
    <link rel="stylesheet" href="css/main.css">
    
    <!-- ğŸ¯ æ‰‹æœºè°ƒè¯•æ ·å¼ - å†…è”å…³é”®CSS -->
    <style>
        /* æ‰‹æœºè°ƒè¯•é¢æ¿ */
        .mobile-debug {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(220, 53, 69, 0.95);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 11px;
            line-height: 1.3;
            z-index: 99999;
            max-width: 200px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
        }
        
        .mobile-debug.success {
            background: rgba(40, 167, 69, 0.95);
        }
        
        .mobile-debug.warning {
            background: rgba(255, 193, 7, 0.95);
            color: #333;
        }
        
        .mobile-debug-item {
            display: flex;
            justify-content: space-between;
            margin: 2px 0;
            padding: 2px 0;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        
        .mobile-debug-item:last-child {
            border-bottom: none;
        }
        
        .mobile-debug-toggle {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(108, 117, 125, 0.9);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 10px;
            cursor: pointer;
            z-index: 99998;
            font-family: monospace;
        }
        
        /* é¡µé¢åŠ è½½çŠ¶æ€ */
        .page-loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        .page-loading-content {
            text-align: center;
            max-width: 400px;
            padding: 40px 20px;
        }
        
        .page-loading h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .page-loading-spinner {
            width: 40px;
            height: 40px;
            margin: 0 auto 20px;
            border: 3px solid #e9ecef;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: pageLoadSpin 1s linear infinite;
        }
        
        @keyframes pageLoadSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .page-loading-text {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 10px;
            min-height: 20px;
        }
        
        .page-loading-progress {
            font-size: 12px;
            color: #007bff;
            font-weight: 500;
        }
        
        .loading-progress-bar {
            width: 280px;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin: 15px auto;
            overflow: hidden;
            position: relative;
        }
        
        .loading-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            width: 0%;
            transition: width 0.4s ease;
            border-radius: 3px;
        }
        
        /* é”™è¯¯çŠ¶æ€æ ·å¼ */
        .page-loading.error {
            background: rgba(248, 215, 218, 0.95);
        }
        
        .page-loading.error .page-loading-spinner {
            border-top-color: #dc3545;
            animation-duration: 2s;
        }
        
        .page-loading.error h2 {
            color: #721c24;
        }
        
        .error-details {
            background: rgba(220, 53, 69, 0.1);
            border: 1px solid rgba(220, 53, 69, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: left;
            font-size: 12px;
            color: #721c24;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .error-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .error-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .error-btn-primary {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
        }
        
        .error-btn-primary:hover {
            background: linear-gradient(135deg, #0056b3, #004085);
            transform: translateY(-1px);
        }
        
        /* åŸºç¡€å¸ƒå±€ */
        body {
            margin: 0;
            padding: 0;
            background: #f8f9fa;
            min-height: 100vh;
        }
        
        .page-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px 0;
        }
        
        .content-wrapper {
            background: white;
            margin: 0 auto;
            max-width: 1400px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            min-height: calc(100vh - 40px);
        }
        
        .top-nav {
            background: #2c3e50;
            color: white;
            padding: 15px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .nav-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin: 0;
        }
        
        .nav-links {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        
        .nav-link {
            color: #ecf0f1;
            text-decoration: none;
            padding: 8px 12px;
            border-radius: 6px;
            transition: background-color 0.3s;
            font-size: 14px;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .nav-link.active {
            background: #3498db;
            color: white;
        }
        
        /* éšè—ç±» */
        .hidden {
            display: none !important;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .page-container {
                padding: 10px;
            }
            
            .content-wrapper {
                border-radius: 8px;
                min-height: calc(100vh - 20px);
            }
            
            .top-nav {
                padding: 15px 20px;
                flex-direction: column;
                text-align: center;
            }
            
            .nav-title {
                font-size: 1.1rem;
            }
            
            .nav-links {
                justify-content: center;
            }
            
            .loading-progress-bar {
                width: 220px;
            }
            
            .mobile-debug {
                font-size: 10px;
                max-width: 150px;
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- ğŸ¯ æ‰‹æœºè°ƒè¯•é¢æ¿ -->
    <button class="mobile-debug-toggle" id="debug-toggle" onclick="toggleMobileDebug()" title="åˆ‡æ¢è°ƒè¯•ä¿¡æ¯">DEBUG</button>
    
    <div class="mobile-debug" id="mobile-debug" style="display: none;">
        <div style="font-weight: bold; margin-bottom: 8px; text-align: center;">ğŸ”§ ç³»ç»ŸçŠ¶æ€</div>
        <div class="mobile-debug-item">
            <span>è„šæœ¬åŠ è½½:</span>
            <span id="debug-scripts">â“</span>
        </div>
        <div class="mobile-debug-item">
            <span>ç®¡ç†å™¨:</span>
            <span id="debug-manager">â“</span>
        </div>
        <div class="mobile-debug-item">
            <span>åˆå§‹åŒ–:</span>
            <span id="debug-init">â“</span>
        </div>
        <div class="mobile-debug-item">
            <span>æ•°æ®é‡:</span>
            <span id="debug-data">â“</span>
        </div>
        <div class="mobile-debug-item">
            <span>æœç´¢çŠ¶æ€:</span>
            <span id="debug-search">â“</span>
        </div>
        <div class="mobile-debug-item">
            <span>æœ€åé”™è¯¯:</span>
            <span id="debug-error">æ— </span>
        </div>
        <div style="margin-top: 8px; text-align: center;">
            <button onclick="forceReinitialize()" style="background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 9px;">é‡æ–°åˆå§‹åŒ–</button>
        </div>
    </div>

    <!-- ğŸ¯ é¡µé¢åŠ è½½æŒ‡ç¤ºå™¨ -->
    <div class="page-loading" id="page-loading">
        <div class="page-loading-content">
            <h2 id="page-loading-title">ğŸ“Š è¯é¢‘ç»Ÿè®¡</h2>
            <div class="page-loading-spinner" id="page-loading-spinner"></div>
            <div class="page-loading-text" id="page-loading-text">æ­£åœ¨åˆå§‹åŒ–ç³»ç»Ÿ...</div>
            <div class="loading-progress-bar">
                <div class="loading-progress-fill" id="page-loading-progress-fill"></div>
            </div>
            <div class="page-loading-progress" id="page-loading-progress">0%</div>
            
            <!-- ğŸ¯ é”™è¯¯è¯¦æƒ…æ˜¾ç¤º -->
            <div class="error-details" id="error-details" style="display: none;">
                <strong>é”™è¯¯è¯¦æƒ…ï¼š</strong>
                <pre id="error-details-content"></pre>
            </div>
            
            <!-- ğŸ¯ é”™è¯¯æ“ä½œæŒ‰é’® -->
            <div class="error-actions" id="error-actions" style="display: none;">
                <!-- åŠ¨æ€ç”Ÿæˆé”™è¯¯æ“ä½œæŒ‰é’® -->
            </div>
        </div>
    </div>

    <!-- ä¸»è¦å†…å®¹å®¹å™¨ -->
    <div class="page-container">
        <div class="content-wrapper">
            <!-- é¡¶éƒ¨å¯¼èˆª -->
            <nav class="top-nav">
                <h1 class="nav-title">ğŸ“Š è¯é¢‘ç»Ÿè®¡åˆ†æ</h1>
                <div class="nav-links">
                    <a href="index.html" class="nav-link">ğŸ  é¦–é¡µ</a>
                    <a href="#" class="nav-link active">ğŸ“Š è¯é¢‘ç»Ÿè®¡</a>
                    <a href="javascript:void(0)" class="nav-link" onclick="showHelp()">â“ å¸®åŠ©</a>
                </div>
            </nav>

            <!-- è¯é¢‘ç»Ÿè®¡ä¸»å®¹å™¨ -->
            <div id="word-frequency-container"></div>
        </div>
    </div>

    <!-- ğŸ¯ å¸®åŠ©æ¨¡æ€æ¡† -->
    <div id="help-modal" style="display: none;">
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 20000; display: flex; justify-content: center; align-items: center; padding: 20px;">
            <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto;">
                <h3 style="margin-top: 0; color: #2c3e50;">ğŸ“– ä½¿ç”¨å¸®åŠ©</h3>
                <div style="line-height: 1.6; color: #495057;">
                    <p><strong>ğŸš€ åŒæ¨¡å¼æœç´¢</strong><br>
                    æœ¬å·¥å…·æä¾›ä¸¤ç§æœç´¢æ¨¡å¼æ¥æ»¡è¶³ä¸åŒçš„æŸ¥æ‰¾éœ€æ±‚ï¼š</p>
                    
                    <p><strong>ğŸ§  æ™ºèƒ½æœç´¢æ¨¡å¼ï¼š</strong><br>
                    åŸºäºè¯æ ¹åˆå¹¶ï¼Œæœç´¢"take"ä¼šæ‰¾åˆ°takeã€takesã€tookã€takenç­‰æ‰€æœ‰ç›¸å…³å˜å½¢è¯çš„åˆå¹¶ç»“æœã€‚é€‚åˆå­¦ä¹ è¯æ±‡å˜åŒ–å’Œè¯­æ³•è§„å¾‹ã€‚</p>
                    
                    <p><strong>ğŸ¯ ç²¾ç¡®æœç´¢æ¨¡å¼ï¼š</strong><br>
                    åŸºäºåŸæ–‡åŒ¹é…ï¼Œæœç´¢"taken"åªä¼šæ‰¾åˆ°åŒ…å«ç¡®åˆ‡å•è¯"taken"çš„æ–‡ç« ã€‚é€‚åˆæŸ¥æ‰¾ç‰¹å®šç”¨æ³•å’Œè¯­å¢ƒã€‚</p>
                    
                    <p><strong>ğŸ” å¦‚ä½•ä½¿ç”¨ï¼š</strong></p>
                    <ul style="padding-left: 20px;">
                        <li><strong>æœç´¢æ¡†ï¼š</strong> è¾“å…¥è¦æŸ¥æ‰¾çš„è‹±æ–‡å•è¯</li>
                        <li><strong>æ¨¡å¼åˆ‡æ¢ï¼š</strong> ç‚¹å‡»"æ™ºèƒ½æœç´¢"æˆ–"ç²¾ç¡®æœç´¢"åˆ‡æ¢æ¨¡å¼</li>
                        <li><strong>æŸ¥çœ‹ç»“æœï¼š</strong> æ”¯æŒè¯äº‘å’Œåˆ—è¡¨ä¸¤ç§æ˜¾ç¤ºæ–¹å¼</li>
                        <li><strong>å•è¯è¯¦æƒ…ï¼š</strong> ç‚¹å‡»å•è¯æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯å’Œå‡ºç°æ–‡ç« </li>
                        <li><strong>æ–‡ç« è·³è½¬ï¼š</strong> ç‚¹å‡»æ–‡ç« æ ‡é¢˜ç›´æ¥è·³è½¬å¹¶é«˜äº®å•è¯</li>
                    </ul>
                    
                    <p><strong>ğŸ’¡ æœç´¢æŠ€å·§ï¼š</strong></p>
                    <ul style="padding-left: 20px;">
                        <li>ä½¿ç”¨æ™ºèƒ½æœç´¢å­¦ä¹ è¯æ±‡å˜åŒ–ï¼šå¦‚æœç´¢"go"äº†è§£go/goes/went/gone</li>
                        <li>ä½¿ç”¨ç²¾ç¡®æœç´¢æŸ¥æ‰¾ç‰¹å®šå½¢å¼ï¼šå¦‚æœç´¢"went"åªçœ‹è¿‡å»å¼ç”¨æ³•</li>
                        <li>æ”¯æŒ3-20ä¸ªå­—ç¬¦çš„è‹±æ–‡å•è¯æœç´¢</li>
                        <li>æœç´¢ç»“æœæŒ‰ç›¸å…³æ€§å’Œé¢‘æ¬¡æ’åº</li>
                    </ul>
                    
                    <p><strong>ğŸ“± ç§»åŠ¨ç«¯æç¤ºï¼š</strong><br>
                    ç‚¹å‡»å³ä¸Šè§’"DEBUG"æŒ‰é’®å¯æŸ¥çœ‹ç³»ç»ŸçŠ¶æ€ï¼Œå¸®åŠ©è¯Šæ–­é—®é¢˜ã€‚</p>
                </div>
                <button onclick="hideHelp()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 20px; width: 100%;">
                    çŸ¥é“äº†
                </button>
            </div>
        </div>
    </div>

    <!-- ğŸ¯ æ ¸å¿ƒè„šæœ¬æ–‡ä»¶ -->
    <script src="js/core.js" defer></script>
    <script src="js/word-frequency.js" defer></script>
    <script src="js/word-frequency-ui.js" defer></script>
    
    <!-- ğŸ¯ ä¸»åº”ç”¨è„šæœ¬ - å®Œå…¨é‡æ„åˆå§‹åŒ–æµç¨‹ -->
    <script>
        // ğŸ¯ å…¨å±€å˜é‡
        let wordFreqManager = null;
        let wordFreqUI = null;
        let initializationStartTime = Date.now();
        let mobileDebugVisible = false;
        let debugUpdateInterval = null;
        let lastKnownError = null;

        // ğŸ¯ æ‰‹æœºè°ƒè¯•ç®¡ç†å™¨
        const MobileDebugger = {
            isVisible: false,
            updateInterval: null,
            
            toggle() {
                this.isVisible = !this.isVisible;
                const panel = document.getElementById('mobile-debug');
                const toggle = document.getElementById('debug-toggle');
                
                if (this.isVisible) {
                    panel.style.display = 'block';
                    toggle.textContent = 'HIDE';
                    toggle.style.background = 'rgba(220, 53, 69, 0.9)';
                    this.startUpdating();
                } else {
                    panel.style.display = 'none';
                    toggle.textContent = 'DEBUG';
                    toggle.style.background = 'rgba(108, 117, 125, 0.9)';
                    this.stopUpdating();
                }
            },
            
            startUpdating() {
                this.update();
                this.updateInterval = setInterval(() => {
                    this.update();
                }, 1000);
            },
            
            stopUpdating() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                }
            },
            
            update() {
                try {
                    // æ£€æŸ¥è„šæœ¬åŠ è½½çŠ¶æ€
                    const scriptsOK = window.EnglishSite && 
                                     window.EnglishSite.WordFrequencyManager && 
                                     window.EnglishSite.WordFrequencyUI;
                    this.updateElement('debug-scripts', scriptsOK ? 'âœ…' : 'âŒ');
                    
                    // æ£€æŸ¥ç®¡ç†å™¨çŠ¶æ€
                    const managerOK = wordFreqManager !== null;
                    this.updateElement('debug-manager', managerOK ? 'âœ…' : 'âŒ');
                    
                    // æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€
                    const initOK = wordFreqManager?.isInitialized === true;
                    const initInProgress = wordFreqManager?.isInitializing === true;
                    const initStatus = initOK ? 'âœ…' : (initInProgress ? 'â³' : 'âŒ');
                    this.updateElement('debug-init', initStatus);
                    
                    // æ£€æŸ¥æ•°æ®é‡
                    const dataSize = wordFreqManager?.analyzer?.wordStats?.size || 0;
                    this.updateElement('debug-data', dataSize.toString());
                    
                    // æ£€æŸ¥æœç´¢çŠ¶æ€
                    const searchOK = wordFreqUI?.searchManager ? 'âœ…' : 'âŒ';
                    this.updateElement('debug-search', searchOK);
                    
                    // æ˜¾ç¤ºæœ€åé”™è¯¯
                    if (lastKnownError) {
                        this.updateElement('debug-error', lastKnownError.substring(0, 20) + '...');
                    }
                    
                    // æ›´æ–°é¢æ¿é¢œè‰²
                    const panel = document.getElementById('mobile-debug');
                    if (initOK && dataSize > 0) {
                        panel.className = 'mobile-debug success';
                    } else if (initInProgress) {
                        panel.className = 'mobile-debug warning';
                    } else {
                        panel.className = 'mobile-debug';
                    }
                    
                } catch (error) {
                    console.error('è°ƒè¯•ä¿¡æ¯æ›´æ–°å¤±è´¥:', error);
                }
            },
            
            updateElement(id, value) {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                }
            }
        };

        // ğŸ¯ é¡µé¢åŠ è½½ç®¡ç†å™¨
        const PageLoader = {
            currentProgress: 0,
            
            updateProgress(progress, text = '') {
                this.currentProgress = progress;
                
                const progressFill = document.getElementById('page-loading-progress-fill');
                const progressText = document.getElementById('page-loading-progress');
                const loadingText = document.getElementById('page-loading-text');
                
                if (progressFill) {
                    progressFill.style.width = `${progress}%`;
                }
                if (progressText) {
                    progressText.textContent = `${progress}%`;
                }
                if (text && loadingText) {
                    loadingText.textContent = text;
                }
            },
            
            hide() {
                const loader = document.getElementById('page-loading');
                if (loader) {
                    loader.style.opacity = '0';
                    setTimeout(() => {
                        loader.style.display = 'none';
                    }, 300);
                }
            },
            
            showError(title, message, actions = [], errorDetails = null) {
                const loader = document.getElementById('page-loading');
                const titleEl = document.getElementById('page-loading-title');
                const spinner = document.getElementById('page-loading-spinner');
                const textEl = document.getElementById('page-loading-text');
                const detailsEl = document.getElementById('error-details');
                const detailsContent = document.getElementById('error-details-content');
                const actionsEl = document.getElementById('error-actions');
                
                if (loader) {
                    loader.classList.add('error');
                }
                
                if (titleEl) {
                    titleEl.textContent = title;
                }
                
                if (spinner) {
                    spinner.style.display = 'none';
                }
                
                if (textEl) {
                    textEl.textContent = message;
                }
                
                if (errorDetails && detailsEl && detailsContent) {
                    detailsContent.textContent = errorDetails;
                    detailsEl.style.display = 'block';
                }
                
                if (actionsEl && actions.length > 0) {
                    actionsEl.innerHTML = actions.map(action => 
                        `<button class="error-btn ${action.type}" onclick="${action.onclick}">
                            ${action.text}
                        </button>`
                    ).join('');
                    actionsEl.style.display = 'flex';
                }
                
                // è®°å½•é”™è¯¯åˆ°è°ƒè¯•å™¨
                lastKnownError = message;
            }
        };

        // ğŸ¯ é”™è¯¯å¤„ç†å‡½æ•°
        function handleReload() {
            location.reload();
        }

        function handleGoHome() {
            window.location.href = 'index.html';
        }

        function showHelp() {
            document.getElementById('help-modal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function hideHelp() {
            document.getElementById('help-modal').style.display = 'none';
            document.body.style.overflow = '';
        }

        function toggleMobileDebug() {
            MobileDebugger.toggle();
        }

        // ğŸ¯ å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–
        function forceReinitialize() {
            console.log('ğŸ”„ å¼ºåˆ¶é‡æ–°åˆå§‹åŒ–...');
            
            // æ¸…ç†ç°æœ‰å®ä¾‹
            if (wordFreqUI && typeof wordFreqUI.destroy === 'function') {
                wordFreqUI.destroy();
                wordFreqUI = null;
            }
            
            if (wordFreqManager && typeof wordFreqManager.destroy === 'function') {
                wordFreqManager.destroy();
                wordFreqManager = null;
            }
            
            // æ¸…ç†ç¼“å­˜
            try {
                sessionStorage.clear();
                if (window.EnglishSite?.CacheManager) {
                    window.EnglishSite.CacheManager.clear();
                }
            } catch (error) {
                console.warn('æ¸…ç†ç¼“å­˜å¤±è´¥:', error);
            }
            
            // é‡æ–°åŠ è½½é¡µé¢
            setTimeout(() => {
                location.reload();
            }, 500);
        }

        // ğŸ¯ ä¸»åˆå§‹åŒ–å‡½æ•° - å®Œå…¨é‡æ„ï¼Œä¸“æ³¨è§£å†³æœç´¢é—®é¢˜
        async function initializeWordFrequencyPage() {
            const initStartTime = Date.now();
            
            try {
                console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–è¯é¢‘ç»Ÿè®¡é¡µé¢...');
                
                PageLoader.updateProgress(10, 'æ£€æŸ¥è„šæœ¬åŠ è½½çŠ¶æ€...');
                
                // ğŸ¯ æ­¥éª¤1: éªŒè¯è„šæœ¬åŠ è½½
                let attempts = 0;
                const maxAttempts = 50; // 5ç§’è¶…æ—¶
                
                while (attempts < maxAttempts) {
                    if (window.EnglishSite?.WordFrequencyManager && window.EnglishSite?.WordFrequencyUI) {
                        console.log('âœ… æ ¸å¿ƒè„šæœ¬å·²åŠ è½½');
                        break;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 100));
                    attempts++;
                }
                
                if (attempts >= maxAttempts) {
                    throw new Error('æ ¸å¿ƒè„šæœ¬åŠ è½½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
                
                PageLoader.updateProgress(20, 'åˆ›å»ºè¯é¢‘ç®¡ç†å™¨...');
                
                // ğŸ¯ æ­¥éª¤2: åˆ›å»ºç®¡ç†å™¨
                console.log('ğŸ“Š åˆ›å»ºè¯é¢‘ç®¡ç†å™¨...');
                wordFreqManager = new window.EnglishSite.WordFrequencyManager();
                
                if (!wordFreqManager) {
                    throw new Error('è¯é¢‘ç®¡ç†å™¨åˆ›å»ºå¤±è´¥');
                }
                
                PageLoader.updateProgress(30, 'éªŒè¯å®¹å™¨å…ƒç´ ...');
                
                // ğŸ¯ æ­¥éª¤3: éªŒè¯å®¹å™¨
                const container = document.getElementById('word-frequency-container');
                if (!container) {
                    throw new Error('å®¹å™¨å…ƒç´  #word-frequency-container æœªæ‰¾åˆ°');
                }
                
                PageLoader.updateProgress(40, 'åˆ›å»ºç”¨æˆ·ç•Œé¢...');
                
                // ğŸ¯ æ­¥éª¤4: åˆ›å»ºUI
                console.log('ğŸ¨ åˆ›å»ºç”¨æˆ·ç•Œé¢...');
                wordFreqUI = new window.EnglishSite.WordFrequencyUI(container, wordFreqManager);
                
                if (!wordFreqUI) {
                    throw new Error('ç”¨æˆ·ç•Œé¢åˆ›å»ºå¤±è´¥');
                }
                
                PageLoader.updateProgress(50, 'ç­‰å¾…æ•°æ®åˆå§‹åŒ–...');
                
                // ğŸ¯ æ­¥éª¤5: ç­‰å¾…æ•°æ®åˆå§‹åŒ–å®Œæˆ
                console.log('â³ ç­‰å¾…æ•°æ®åˆå§‹åŒ–...');
                
                // ğŸ¯ å¢å¼ºçš„ç­‰å¾…é€»è¾‘ - å®šæœŸæ£€æŸ¥çŠ¶æ€
                const waitStartTime = Date.now();
                const maxWaitTime = 60000; // 60ç§’
                
                while (Date.now() - waitStartTime < maxWaitTime) {
                    PageLoader.updateProgress(
                        50 + Math.min(45, (Date.now() - waitStartTime) / maxWaitTime * 45),
                        'æ­£åœ¨åˆ†ææ–‡ç« å†…å®¹...'
                    );
                    
                    // æ£€æŸ¥åˆå§‹åŒ–çŠ¶æ€
                    if (wordFreqManager.isInitialized) {
                        console.log('âœ… æ•°æ®åˆå§‹åŒ–å®Œæˆ');
                        break;
                    }
                    
                    // æ£€æŸ¥é”™è¯¯çŠ¶æ€
                    if (wordFreqManager.initializationError) {
                        throw wordFreqManager.initializationError;
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                // ğŸ¯ éªŒè¯æ•°æ®åŠ è½½
                const dataSize = wordFreqManager.analyzer?.wordStats?.size || 0;
                console.log(`ğŸ“Š æ•°æ®éªŒè¯: ${dataSize} ä¸ªå•è¯`);
                
                if (dataSize === 0) {
                    console.warn('âš ï¸ æ•°æ®ä¸ºç©ºï¼Œå°è¯•å¼ºåˆ¶åˆå§‹åŒ–...');
                    
                    // ğŸ¯ å¼ºåˆ¶åˆ›å»ºæµ‹è¯•æ•°æ®
                    await createTestData();
                }
                
                PageLoader.updateProgress(95, 'åˆå§‹åŒ–ç”¨æˆ·ç•Œé¢...');
                
                // ğŸ¯ æ­¥éª¤6: åˆå§‹åŒ–UI
                console.log('ğŸ”— åˆå§‹åŒ–ç”¨æˆ·ç•Œé¢...');
                await wordFreqUI.initialize();
                
                PageLoader.updateProgress(100, 'åˆå§‹åŒ–å®Œæˆï¼');
                
                const initTime = ((Date.now() - initStartTime) / 1000).toFixed(1);
                console.log(`âœ… è¯é¢‘ç»Ÿè®¡é¡µé¢åˆå§‹åŒ–å®Œæˆï¼Œè€—æ—¶ ${initTime}s`);
                
                // ğŸ¯ æœ€ç»ˆéªŒè¯
                const finalDataSize = wordFreqManager.analyzer?.wordStats?.size || 0;
                console.log(`ğŸ¯ æœ€ç»ˆæ•°æ®éªŒè¯: ${finalDataSize} ä¸ªå•è¯å¯ä¾›æœç´¢`);
                
                if (finalDataSize === 0) {
                    throw new Error('æ•°æ®åŠ è½½å¤±è´¥ï¼šæ— å•è¯æ•°æ®å¯ä¾›æœç´¢');
                }
                
                setTimeout(() => {
                    PageLoader.hide();
                }, 600);
                
                console.log('ğŸ‰ ç³»ç»Ÿå°±ç»ªï¼Œæœç´¢åŠŸèƒ½å¯ç”¨ï¼');

            } catch (error) {
                console.error('âŒ è¯é¢‘ç»Ÿè®¡é¡µé¢åˆå§‹åŒ–å¤±è´¥:', error);
                
                // è®°å½•é”™è¯¯
                lastKnownError = error.message;
                
                // æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
                PageLoader.showError(
                    'ğŸš« åˆå§‹åŒ–å¤±è´¥', 
                    error.message || 'é¡µé¢åˆå§‹åŒ–æ—¶é‡åˆ°äº†é—®é¢˜',
                    [
                        { text: 'ğŸ”„ é‡æ–°åŠ è½½', type: 'error-btn-primary', onclick: 'handleReload()' },
                        { text: 'ğŸ  è¿”å›é¦–é¡µ', type: 'error-btn-primary', onclick: 'handleGoHome()' }
                    ],
                    `é”™è¯¯è¯¦æƒ…:\n${error.stack || error.message}`
                );
            }
        }

        // ğŸ¯ åˆ›å»ºæµ‹è¯•æ•°æ® - ç¡®ä¿æœ‰æ•°æ®å¯ä¾›æœç´¢
        async function createTestData() {
            console.log('ğŸ§ª åˆ›å»ºæµ‹è¯•æ•°æ®...');
            
            try {
                const testArticles = [
                    {
                        id: 'test-article-1',
                        title: 'English Learning Basics',
                        content: 'Learning English requires practice and dedication. Students should take time to study grammar rules, vocabulary words, and pronunciation patterns. Taking notes helps remember important concepts. The teacher takes great care to explain difficult topics clearly.'
                    },
                    {
                        id: 'test-article-2', 
                        title: 'Grammar Fundamentals',
                        content: 'Grammar forms the foundation of good writing. Understanding verb tenses, noun usage, and sentence structure is essential. Practice makes perfect when learning grammatical rules. Students practice daily to improve their skills.'
                    },
                    {
                        id: 'test-article-3',
                        title: 'Vocabulary Building',
                        content: 'Building vocabulary is crucial for language success. Reading books, studying word lists, and using new words in context helps expand knowledge. Words have different meanings in different contexts. Students learn new words every day through reading and practice.'
                    }
                ];
                
                // ç›´æ¥è°ƒç”¨åˆ†æå™¨åˆ†ææµ‹è¯•æ–‡ç« 
                for (const article of testArticles) {
                    wordFreqManager.analyzer.analyzeArticle(article.id, article.content, article.title);
                }
                
                const testDataSize = wordFreqManager.analyzer.wordStats.size;
                console.log(`âœ… æµ‹è¯•æ•°æ®åˆ›å»ºå®Œæˆ: ${testDataSize} ä¸ªå•è¯`);
                
                return testDataSize > 0;
                
            } catch (error) {
                console.error('âŒ æµ‹è¯•æ•°æ®åˆ›å»ºå¤±è´¥:', error);
                return false;
            }
        }

        // ğŸ¯ è¿›åº¦äº‹ä»¶ç›‘å¬
        document.addEventListener('wordFreqProgress', (e) => {
            const progress = e.detail.progress;
            const currentBase = Math.min(PageLoader.currentProgress, 50);
            const adjustedProgress = currentBase + (progress * 0.45); // ä¸ºåˆå§‹åŒ–è¿›åº¦ç•™å‡ºç©ºé—´
            PageLoader.updateProgress(adjustedProgress, 'æ­£åœ¨åˆ†ææ–‡ç« å†…å®¹...');
        });

        // ğŸ¯ å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', (e) => {
            console.error('ğŸš¨ å…¨å±€é”™è¯¯:', e.error);
            lastKnownError = e.error?.message || 'æœªçŸ¥é”™è¯¯';
        });

        window.addEventListener('unhandledrejection', (e) => {
            console.error('ğŸš¨ æœªå¤„ç†çš„Promiseé”™è¯¯:', e.reason);
            lastKnownError = e.reason?.message || e.reason || 'å¼‚æ­¥æ“ä½œé”™è¯¯';
        });

        // ğŸ¯ é¡µé¢å¸è½½æ¸…ç†
        window.addEventListener('beforeunload', () => {
            if (wordFreqManager && typeof wordFreqManager.destroy === 'function') {
                wordFreqManager.destroy();
            }
            if (wordFreqUI && typeof wordFreqUI.destroy === 'function') {
                wordFreqUI.destroy();
            }
            MobileDebugger.stopUpdating();
        });

        // ğŸ¯ DOMåŠ è½½å®Œæˆåå¯åŠ¨
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initializeWordFrequencyPage();
            });
        } else {
            initializeWordFrequencyPage();
        }
    </script>
</body>
</html>